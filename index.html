<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Language" content="he">
    <meta name="language" content="Hebrew">
    <title>××—×©×‘×•×Ÿ ×¢××œ×•×ª ××‘×•×¡×¡ ×ª×¤×§×™×“×™×</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="p-4 md:p-8">
    <div class="container mx-auto max-w-7xl">
        <header class="mb-8 text-center">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800">××—×©×‘×•×Ÿ ×¢××œ×•×ª ××‘×•×¡×¡ ×ª×¤×§×™×“×™×</h1>
        </header>

        <div id="statusMessageArea" class="mb-4"></div>

        <div class="main-container md:flex md:space-x-reverse md:space-x-8">
            <div class="form-column md:w-1/2 no-print">
                <div class="bg-white p-4 rounded-lg shadow-md mb-6">
                    <h2 class="text-xl font-semibold text-gray-700 mb-3">×‘×—×¨ ×ª×¤×§×™×“</h2>
                    <select id="roleSelector" class="select-field">
                        <option value="">×˜×•×¢×Ÿ ×ª×¤×§×™×“×™×...</option>
                    </select>
                </div>

                <div class="bg-white p-4 rounded-lg shadow-md mb-6">
                    <h2 class="text-xl font-semibold text-gray-700 mb-3">×¤×¨×•×¤×™×œ×™× (<span id="currentRoleForProfiles"></span>)</h2>
                    <div class="flex items-center space-x-reverse space-x-2">
                        <select id="profilesDropdown" class="select-field flex-grow">
                            <option value="">×˜×¢×Ÿ ×¤×¨×•×¤×™×œ...</option>
                        </select>
                        <button id="saveProfileBtn" class="btn btn-primary">×©××•×¨</button>
                        <button id="deleteProfileBtn" class="btn btn-danger">××—×§</button>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-lg shadow-lg">
                    <h2 class="text-2xl font-semibold text-gray-700 mb-6">×”×–× ×ª × ×ª×•× ×™×</h2>
                    <div class="input-group">
                        <label for="repName" class="input-label">×©× ×”× ×¦×™×’:</label>
                        <input type="text" id="repName" class="input-field" value="× ×¦×™×’ ×œ×“×•×’××”">
                    </div>
                    <div class="grid grid-cols-2 gap-4 input-group">
                        <div><label for="periodMonth" class="input-label">×—×•×“×©:</label><input type="number" id="periodMonth" class="input-field" placeholder="5" value="5"></div>
                        <div><label for="periodYear" class="input-label">×©× ×”:</label><input type="number" id="periodYear" class="input-field" placeholder="2024" value="2024"></div>
                    </div>
                    
                    <div id="dynamicCategoriesContainer"></div>

                    <div class="flex space-x-reverse space-x-2 mt-6">
                        <button id="resetFormBtn" class="btn btn-secondary">××¤×¡ ×˜×•×¤×¡</button>
                        <button id="toggleSettingsBtn" class="btn btn-secondary" disabled title="×‘×—×¨ ×ª×¤×§×™×“ ×ª×—×™×œ×”">×”×¦×’ ×”×’×“×¨×•×ª ×ª×¤×§×™×“</button>
                        <button id="debugBtn" class="btn btn-secondary" style="background-color: #ffa500;">ğŸ”§ Debug</button>
                    </div>
                </div>
                
                <div id="settingsPanel" class="bg-gray-50 p-6 rounded-lg shadow-inner mt-6" style="display: none;">
                    <h2 class="text-2xl font-semibold text-gray-700 mb-2">×”×’×“×¨×•×ª ×‘×•× ×•×¡×™× ×¢×‘×•×¨: <span id="settingsRoleName" class="text-blue-600"></span></h2>
                    <p class="text-sm text-gray-500 mb-6">×©×™× ×•×™×™× × ×©××¨×™× ××•×˜×•××˜×™×ª ×œ×××’×¨ ×”× ×ª×•× ×™×.</p>
                    <div id="settingsContainer"></div>
                    <button id="saveRoleSettingsBtn" class="btn btn-primary mt-4">×©××•×¨ ×”×’×“×¨×•×ª ×ª×¤×§×™×“</button>
                </div>
            </div>

            <div class="results-column md:w-1/2 mt-8 md:mt-0">
                <div class="results-card" id="resultsReport">
                    <h2 class="text-2xl font-semibold text-gray-700 mb-1">×¡×™×›×•× ×”×‘×•× ×•×¡ ×¢×‘×•×¨ <span id="resultRepName" class="text-blue-700"></span></h2>
                    <p class="text-sm text-gray-500 mb-4">×ª×¤×§×™×“: <span id="resultRoleName" class="font-medium"></span>, ×ª×§×•×¤×”: <span id="resultPeriod"></span></p>
                    <div class="text-center mb-6"><p class="text-gray-600 text-lg">×”×‘×•× ×•×¡ ×”×›×•×œ×œ ×œ×ª×§×•×¤×”:</p><p id="totalBonusAmount" class="total-bonus-amount">â‚ª0</p></div>
                    <div class="details-section"><h3 class="flex justify-between items-center">×¤×™×¨×•×˜ ×”×‘×•× ×•×¡</h3>
                        <div id="bonusDetailsContent">
                            <div class="mt-2"><h4 class="font-medium text-gray-700">×‘×•× ×•×¡ ×¢×œ ×‘×™×¦×•×¢×™×: <span id="totalPerformanceBonus" class="font-semibold">â‚ª0</span></h4><ul id="performanceBonusList" class="pr-2"></ul></div>
                            <div class="mt-4"><h4 class="font-medium text-gray-700">×‘×•× ×•×¡ ×¢××™×“×” ×‘×™×¢×“×™×: <span id="totalTargetBonus" class="font-semibold">â‚ª0</span></h4><ul id="targetBonusList" class="pr-2"></ul></div>
                        </div>
                    </div>
                </div>
                <div class="flex space-x-reverse space-x-2 mt-4 no-print">
                    <button id="printBtn" class="btn btn-primary">×”×“×¤×¡ / ×©××•×¨ ×›-PDF</button>
                    <button id="exportCsvBtn" class="btn btn-secondary">×™×™×¦× ×œ-CSV</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- GLOBAL APP VARS ---
        let currentSelectedRoleId = null;
        let rolesData = {}; // To store all loaded roles
        let currentCategoryDefinitions = [];
        let currentBonusSettings = {};
        let profiles = {}; // User-specific profiles

        // --- DOM ELEMENTS ---
        const repNameInput = document.getElementById('repName');
        const periodMonthInput = document.getElementById('periodMonth');
        const periodYearInput = document.getElementById('periodYear');
        const resultRepName = document.getElementById('resultRepName');
        const resultPeriod = document.getElementById('resultPeriod');
        const resultRoleName = document.getElementById('resultRoleName');
        const totalBonusAmount = document.getElementById('totalBonusAmount');
        const totalPerformanceBonus = document.getElementById('totalPerformanceBonus');
        const performanceBonusList = document.getElementById('performanceBonusList');
        const totalTargetBonus = document.getElementById('totalTargetBonus');
        const targetBonusList = document.getElementById('targetBonusList');
        
        const roleSelector = document.getElementById('roleSelector');
        const currentRoleForProfiles = document.getElementById('currentRoleForProfiles');
        const dynamicCategoriesContainer = document.getElementById('dynamicCategoriesContainer');
        
        const settingsPanel = document.getElementById('settingsPanel');
        const settingsRoleName = document.getElementById('settingsRoleName');
        const settingsContainer = document.getElementById('settingsContainer');
        const toggleSettingsBtn = document.getElementById('toggleSettingsBtn');
        const saveRoleSettingsBtn = document.getElementById('saveRoleSettingsBtn');

        const profilesDropdown = document.getElementById('profilesDropdown');
        const saveProfileBtn = document.getElementById('saveProfileBtn');
        const deleteProfileBtn = document.getElementById('deleteProfileBtn');
        const resetFormBtn = document.getElementById('resetFormBtn');
        const printBtn = document.getElementById('printBtn');
        const exportCsvBtn = document.getElementById('exportCsvBtn');
        const statusMessageArea = document.getElementById('statusMessageArea');

        // --- DEFAULT ROLE STRUCTURES ---
        const DEFAULT_ROLE_STRUCTURES = {
            "test_simple": {
                name: "××‘×—×Ÿ ×¤×©×•×˜",
                categoryDefinitions: [
                    { id: 'testCategory', name: '×§×˜×’×•×¨×™×™×ª ××‘×—×Ÿ', type: 'performance_tiered_percentage', goalInput: true, actualInput: true }
                ],
                bonusSettings: {
                    testCategory: { 
                        tiers: [
                            { threshold: 0.86, value: 20 }, 
                            { threshold: 0.81, value: 15 }, 
                            { threshold: 0.75, value: 10 }
                        ], 
                        targetThreshold: 0.95, 
                        targetBonus: 250 
                    }
                }
            },
            "default_reps": {
                name: "× ×¦×™×’×™×",
                categoryDefinitions: [
                    { id: 'personalRenewals', name: '×—×™×“×•×©×™× ××™×©×™×™×', type: 'performance_tiered_percentage', goalInput: true, actualInput: true },
                    { id: 'teamRenewals', name: '×—×™×“×•×©×™× ×¦×•×•×ª×™×™×', type: 'threshold_only', goalInput: true, actualInput: true },
                    { id: 'newSales', name: '××›×™×¨×•×ª ×—×“×©×•×ª', type: 'performance_tiered_percentage', goalInput: true, actualInput: true },
                    { id: 'ridersSales', name: '××›×™×¨×•×ª ×¨×™×™×“×¨×™×', type: 'performance_fixed_multiplier', goalInput: true, actualInput: true }
                ],
                bonusSettings: {
                    personalRenewals: { tiers: [{ threshold: 0.86, value: 20 }, { threshold: 0.81, value: 15 }, { threshold: 0.75, value: 10 }, { threshold: 0.01, value: 5 }], targetThreshold: 0.95, targetBonus: 250 },
                    teamRenewals: { targetThreshold: 0.88, targetBonus: 250 },
                    newSales: { tiers: [{ threshold: 0.81, value: 70 }, { threshold: 0.61, value: 50 }, { threshold: 0.31, value: 40 }, { threshold: 0.01, value: 20 }], targetThreshold: 1.25, targetBonus: 250 },
                    ridersSales: { multiplier: 20 }
                }
            },
            "senior_reps": {
                name: "× ×¦×™×’ ×‘×›×™×¨",
                categoryDefinitions: [
                    { id: 'personalRenewalsSr', name: '×™×¢×“ ××™×©×™ (×‘×›×™×¨)', type: 'performance_tiered_percentage', goalInput: true, actualInput: true },
                    { id: 'teamRenewalsSr', name: '×™×¢×“ ×¦×•×•×ª×™ (×‘×›×™×¨)', type: 'threshold_only', goalInput: true, actualInput: true },
                    { id: 'newSalesSr', name: '××›×™×¨×•×ª ×—×“×©×•×ª (×‘×›×™×¨)', type: 'performance_tiered_percentage', goalInput: true, actualInput: true },
                    { id: 'ridersSalesSr', name: '××›×™×¨×•×ª ×¨×™×™×“×¨×™× (×‘×›×™×¨)', type: 'performance_fixed_multiplier', goalInput: true, actualInput: true }
                ],
                bonusSettings: {
                    personalRenewalsSr: { tiers: [{ threshold: 0.86, value: 25 }, { threshold: 0.81, value: 20 }, { threshold: 0.75, value: 15 }, { threshold: 0.00, value: 10 }], targetThreshold: 0.97, targetBonus: 300 },
                    teamRenewalsSr: { targetThreshold: 0.90, targetBonus: 300 },
                    newSalesSr: { tiers: [{ threshold: 0.81, value: 80 }, { threshold: 0.61, value: 60 }, { threshold: 0.31, value: 50 }, { threshold: 0.01, value: 25 }], targetThreshold: 1.30, targetBonus: 300 },
                    ridersSalesSr: { multiplier: 25 }
                }
            },
            "control_service": {
                name: "×©×™×¨×•×ª ×‘×§×¨×”",
                categoryDefinitions: [
                    { id: 'personalGoalCs', name: '×™×¢×“ ××™×©×™ (×‘×§×¨×”)', type: 'threshold_percentage_bonus', goalInput: true, actualInput: true },
                    { id: 'teamGoalCs', name: '×™×¢×“ ×¦×•×•×ª×™ (×‘×§×¨×”)', type: 'threshold_percentage_bonus', goalInput: true, actualInput: true },
                    { id: 'excellenceCs', name: '×‘×•× ×•×¡ ×”×¦×˜×™×™× ×•×ª', type: 'fixed_bonus_on_condition', goalInput: false, actualInput: true }
                ],
                bonusSettings: {
                    personalGoalCs: { tiers: [{ percentage_threshold: 1.0, bonus: 500 }, { percentage_threshold: 0.9, bonus: 250 }], targetBonus: 0 },
                    teamGoalCs: { tiers: [{ percentage_threshold: 1.0, bonus: 400 }, { percentage_threshold: 0.9, bonus: 200 }], targetBonus: 0 },
                    excellenceCs: { conditionValue: 1, bonusAmount: 300 }
                }
            }
        };
        
        // --- UTILITY FUNCTIONS ---
        const formatCurrency = (amount) => {
            if (typeof amount !== 'number' || isNaN(amount)) {
                amount = 0;
            }
            const formatted = amount.toLocaleString('he-IL');
            return `â‚ª${formatted}`;
        };
        const formatPercentage = (value) => `${(value * 100).toFixed(1)}%`;
        const getInputValue = (id) => {
            const el = document.getElementById(id);
            if (!el) return 0;
            const value = parseFloat(el.value);
            return isNaN(value) ? 0 : value;
        }

        function showStatusMessage(message, isSuccess = true) {
            if (statusMessageArea) {
                statusMessageArea.innerHTML = `<div class="status-message ${isSuccess ? 'status-success' : 'status-error'}">${message}</div>`;
                setTimeout(() => { statusMessageArea.innerHTML = ''; }, 3000);
            }
        }

        // --- LOCAL STORAGE FUNCTIONS ---
        function saveToLocalStorage(key, data) {
            try {
                localStorage.setItem(key, JSON.stringify(data));
                return true;
            } catch (error) {
                console.error('Error saving to localStorage:', error);
                return false;
            }
        }

        function loadFromLocalStorage(key, defaultValue = null) {
            try {
                const data = localStorage.getItem(key);
                return data ? JSON.parse(data) : defaultValue;
            } catch (error) {
                console.error('Error loading from localStorage:', error);
                return defaultValue;
            }
        }

        // --- DATA MANAGEMENT ---
        function loadAllRoles() {
            console.log("ğŸ”„ Loading roles...");
            showStatusMessage("×˜×•×¢×Ÿ ×ª×¤×§×™×“×™×...", true);
            
            try {
                // Load from localStorage or use defaults
                const savedRoles = loadFromLocalStorage('commissionRoles', DEFAULT_ROLE_STRUCTURES);
                rolesData = savedRoles;
                
                console.log("ğŸ“Š Loaded roles data:", rolesData);
                console.log("ğŸ“Š Number of roles:", Object.keys(rolesData).length);
                
                // Ensure roleSelector exists
                if (!roleSelector) {
                    console.error("âŒ roleSelector element not found!");
                    showStatusMessage("×©×’×™××”: ×œ× × ××¦× ××œ×× ×˜ ×‘×—×™×¨×ª ×ª×¤×§×™×“", false);
                    return;
                }
                
                // Populate role selector
                roleSelector.innerHTML = '<option value="">×‘×—×¨ ×ª×¤×§×™×“...</option>';
                
                Object.keys(rolesData).forEach(roleId => {
                    const option = document.createElement('option');
                    option.value = roleId;
                    option.textContent = rolesData[roleId].name;
                    roleSelector.appendChild(option);
                    console.log("â• Added role:", roleId, "-", rolesData[roleId].name);
                });

                showStatusMessage(`×ª×¤×§×™×“×™× × ×˜×¢× ×• ×‘×”×¦×œ×—×”! (${Object.keys(rolesData).length} ×ª×¤×§×™×“×™×)`, true);
                
                // Auto-select first role
                if (roleSelector.options.length > 1) {
                    const lastSelectedRoleId = localStorage.getItem('lastSelectedRoleId');
                    if (lastSelectedRoleId && rolesData[lastSelectedRoleId]) {
                        roleSelector.value = lastSelectedRoleId;
                    } else {
                        roleSelector.value = roleSelector.options[1].value;
                    }
                    handleRoleChange();
                }
            } catch (error) {
                showStatusMessage("×©×’×™××” ×‘×˜×¢×™× ×ª ×”×ª×¤×§×™×“×™×: " + error.message, false);
            }
        }

        function handleRoleChange() {
            const selectedId = roleSelector.value;
            
            if (!selectedId || !rolesData[selectedId]) {
                currentSelectedRoleId = null;
                currentCategoryDefinitions = [];
                currentBonusSettings = {};
                dynamicCategoriesContainer.innerHTML = '<p class="text-gray-500">×× × ×‘×—×¨ ×ª×¤×§×™×“ ×œ×”×¦×’×ª ×§×˜×’×•×¨×™×•×ª.</p>';
                settingsContainer.innerHTML = '<p class="text-gray-500">×× × ×‘×—×¨ ×ª×¤×§×™×“ ×œ×¢×¨×™×›×ª ×”×’×“×¨×•×ª.</p>';
                settingsRoleName.textContent = "";
                currentRoleForProfiles.textContent = "×× × ×‘×—×¨ ×ª×¤×§×™×“";
                // Disable settings button when no role is selected
                toggleSettingsBtn.disabled = true;
                toggleSettingsBtn.title = "×‘×—×¨ ×ª×¤×§×™×“ ×ª×—×™×œ×”";
                // Hide settings panel if it's open
                settingsPanel.style.display = 'none';
                toggleSettingsBtn.textContent = '×”×¦×’ ×”×’×“×¨×•×ª ×ª×¤×§×™×“';
                return;
            }

            currentSelectedRoleId = selectedId;
            localStorage.setItem('lastSelectedRoleId', currentSelectedRoleId);

            const role = rolesData[currentSelectedRoleId];
            
            currentCategoryDefinitions = role.categoryDefinitions || [];
            currentBonusSettings = JSON.parse(JSON.stringify(role.bonusSettings || {}));

            settingsRoleName.textContent = role.name;
            currentRoleForProfiles.textContent = role.name;
            resultRoleName.textContent = role.name;

            buildFormCategories(currentCategoryDefinitions);
            buildSettingsForm(currentCategoryDefinitions, currentBonusSettings);
            
            // Enable settings button when a role is selected
            toggleSettingsBtn.disabled = false;
            toggleSettingsBtn.title = "";
            
            loadUserProfiles();
            calculateBonuses();
        }

        function buildFormCategories(categories) {
            let html = '';
            if (!categories || categories.length === 0) {
                html = '<p class="text-gray-500">×œ×ª×¤×§×™×“ ×–×” ××™×Ÿ ×§×˜×’×•×¨×™×•×ª ××•×’×“×¨×•×ª.</p>';
            } else {
                categories.forEach(cat => {
                    html += `
                        <div class="input-group border-t pt-4 mt-4">
                            <h3 class="text-lg font-semibold text-gray-600 mb-2">${cat.name}</h3>
                            <div class="grid grid-cols-2 gap-4">
                                ${cat.goalInput ? `<div><label for="${cat.id}Goal" class="input-label">×™×¢×“:</label><input type="number" id="${cat.id}Goal" class="input-field data-input" value="0"></div>` : '<div></div>'}
                                ${cat.actualInput ? `<div><label for="${cat.id}Actual" class="input-label">×‘×™×¦×•×¢ ×‘×¤×•×¢×œ:</label><input type="number" id="${cat.id}Actual" class="input-field data-input" value="0"></div>` : '<div></div>'}
                            </div>
                        </div>`;
                });
            }
            dynamicCategoriesContainer.innerHTML = html;
            
            // Attach data input listeners
            attachDataInputListeners();
        }

        function buildSettingsForm(categories, currentSettings) {
            let html = '';
            if (!categories || categories.length === 0) {
                html = '<p class="text-gray-500">××™×Ÿ ×”×’×“×¨×•×ª ×–××™× ×•×ª ×œ×ª×¤×§×™×“ ×–×”.</p>';
                settingsContainer.innerHTML = html;
                return;
            }

            categories.forEach(cat => {
                const catSettings = currentSettings[cat.id] || {};
                html += `<div class="settings-category-block">
                            <h4 class="text-md font-semibold text-gray-700 mb-3">${cat.name}</h4>`;

                if (cat.type === 'performance_tiered_percentage' || cat.type === 'performance_tiered_amount') {
                    html += `<div class="mb-4">
                                <label class="input-label">××“×¨×’×•×ª ×‘×•× ×•×¡:</label>
                                <div class="text-xs text-gray-500 mb-2">×¡×£ (${cat.type === 'performance_tiered_percentage' ? '××—×•×–' : '×›××•×ª'}) | ××›×¤×™×œ</div>
                                <div id="tiers-${cat.id}" class="space-y-2">`;
                    
                    (catSettings.tiers || []).forEach((tier, i) => {
                        html += `<div class="tier-row flex items-center gap-2">
                                    <input type="number" step="0.01" class="input-field setting-input flex-1" 
                                           data-setting-category="${cat.id}" data-setting-type="tier-threshold" 
                                           data-tier-index="${i}" value="${tier.threshold}" 
                                           placeholder="×¡×£ ${cat.type === 'performance_tiered_percentage' ? '(0.81 = 81%)' : '(××¡×¤×¨)'}">
                                    <input type="number" class="input-field setting-input flex-1" 
                                           data-setting-category="${cat.id}" data-setting-type="tier-value" 
                                           data-tier-index="${i}" value="${tier.value}" 
                                           placeholder="××›×¤×™×œ">
                                    <button type="button" class="btn-remove-tier text-red-500 hover:text-red-700 px-2 py-1" 
                                            data-category="${cat.id}" data-tier-index="${i}">
                                        âœ•
                                    </button>
                                 </div>`;
                    });

                    html += `</div>
                             <button type="button" class="btn-add-tier mt-2 text-blue-500 hover:text-blue-700 text-sm" 
                                     data-category="${cat.id}">
                                 + ×”×•×¡×£ ××“×¨×’×”
                             </button>
                           </div>`;

                    if (catSettings.hasOwnProperty('targetThreshold')) {
                         html += `<div class="mb-4">
                                    <label class="input-label">×¡×£ ×‘×•× ×•×¡ ×™×¢×“:</label>
                                    <input type="number" step="0.01" class="input-field setting-input" 
                                           data-setting-category="${cat.id}" data-setting-type="targetThreshold" 
                                           value="${catSettings.targetThreshold}" 
                                           placeholder="${cat.type === 'performance_tiered_percentage' ? '0.95 = 95%' : '×›××•×ª'}">
                                  </div>`;
                    }

                    if (catSettings.hasOwnProperty('targetBonus')) {
                         html += `<div class="mb-4">
                                    <label class="input-label">×¡×›×•× ×‘×•× ×•×¡ ×™×¢×“:</label>
                                    <input type="number" class="input-field setting-input" 
                                           data-setting-category="${cat.id}" data-setting-type="targetBonus" 
                                           value="${catSettings.targetBonus}" 
                                           placeholder="×¡×›×•× ×‘×©×´×—">
                                  </div>`;
                    }
                } else if (cat.type === 'performance_fixed_multiplier') {
                    html += `<div class="mb-4">
                                <label class="input-label">××›×¤×™×œ ×§×‘×•×¢:</label>
                                <input type="number" class="input-field setting-input" 
                                       data-setting-category="${cat.id}" data-setting-type="multiplier" 
                                       value="${catSettings.multiplier || 0}" 
                                       placeholder="××›×¤×™×œ">
                              </div>`;
                } else if (cat.type === 'threshold_only') {
                    if (catSettings.hasOwnProperty('targetThreshold')) {
                         html += `<div class="mb-4">
                                    <label class="input-label">×¡×£ ×œ×‘×•× ×•×¡ ×™×¢×“:</label>
                                    <input type="number" step="0.01" class="input-field setting-input" 
                                           data-setting-category="${cat.id}" data-setting-type="targetThreshold" 
                                           value="${catSettings.targetThreshold}" 
                                           placeholder="0.88 = 88%">
                                  </div>`;
                    }
                    if (catSettings.hasOwnProperty('targetBonus')) {
                         html += `<div class="mb-4">
                                    <label class="input-label">×¡×›×•× ×‘×•× ×•×¡ ×™×¢×“:</label>
                                    <input type="number" class="input-field setting-input" 
                                           data-setting-category="${cat.id}" data-setting-type="targetBonus" 
                                           value="${catSettings.targetBonus}" 
                                           placeholder="×¡×›×•× ×‘×©×´×—">
                                  </div>`;
                    }
                }

                html += `</div>`;
            });
            settingsContainer.innerHTML = html;
            
            // Attach event listeners for the new buttons
            attachSettingsEventListeners();
        }

        // --- SETTINGS EVENT LISTENERS ---
        function attachSettingsEventListeners() {
            // Add tier buttons
            document.querySelectorAll('.btn-add-tier').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const categoryId = e.target.getAttribute('data-category');
                    addNewTier(categoryId);
                });
            });

            // Remove tier buttons
            document.querySelectorAll('.btn-remove-tier').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const categoryId = e.target.getAttribute('data-category');
                    const tierIndex = parseInt(e.target.getAttribute('data-tier-index'));
                    removeTier(categoryId, tierIndex);
                });
            });

            // Auto-save on input changes
            document.querySelectorAll('.setting-input').forEach(input => {
                input.addEventListener('change', saveCurrentSettings);
                input.addEventListener('blur', saveCurrentSettings);
            });
        }

        function addNewTier(categoryId) {
            if (!currentBonusSettings[categoryId]) {
                currentBonusSettings[categoryId] = { tiers: [] };
            }
            if (!currentBonusSettings[categoryId].tiers) {
                currentBonusSettings[categoryId].tiers = [];
            }

            // Add new tier with default values
            currentBonusSettings[categoryId].tiers.push({ threshold: 0.01, value: 1 });
            
            // Rebuild the settings form
            buildSettingsForm(currentCategoryDefinitions, currentBonusSettings);
            
            showStatusMessage('××“×¨×’×” ×—×“×©×” × ×•×¡×¤×”', true);
        }

        function removeTier(categoryId, tierIndex) {
            if (!currentBonusSettings[categoryId] || !currentBonusSettings[categoryId].tiers) return;
            
            if (currentBonusSettings[categoryId].tiers.length <= 1) {
                showStatusMessage('×œ× × ×™×ª×Ÿ ×œ××—×•×§ ××ª ×”××“×¨×’×” ×”××—×¨×•× ×”', false);
                return;
            }

            currentBonusSettings[categoryId].tiers.splice(tierIndex, 1);
            
            // Rebuild the settings form
            buildSettingsForm(currentCategoryDefinitions, currentBonusSettings);
            
            showStatusMessage('××“×¨×’×” × ××—×§×”', true);
        }

        function saveCurrentSettings() {
            // Collect all settings from form inputs
            document.querySelectorAll('.setting-input').forEach(input => {
                const categoryId = input.getAttribute('data-setting-category');
                const settingType = input.getAttribute('data-setting-type');
                const tierIndex = input.getAttribute('data-tier-index');
                const value = parseFloat(input.value) || 0;

                if (!currentBonusSettings[categoryId]) {
                    currentBonusSettings[categoryId] = {};
                }

                if (settingType === 'tier-threshold' || settingType === 'tier-value') {
                    if (!currentBonusSettings[categoryId].tiers) {
                        currentBonusSettings[categoryId].tiers = [];
                    }
                    if (!currentBonusSettings[categoryId].tiers[tierIndex]) {
                        currentBonusSettings[categoryId].tiers[tierIndex] = {};
                    }
                    
                    if (settingType === 'tier-threshold') {
                        currentBonusSettings[categoryId].tiers[tierIndex].threshold = value;
                    } else if (settingType === 'tier-value') {
                        currentBonusSettings[categoryId].tiers[tierIndex].value = value;
                    }
                } else {
                    currentBonusSettings[categoryId][settingType] = value;
                }
            });

            // Update the role data
            if (currentSelectedRoleId && rolesData[currentSelectedRoleId]) {
                rolesData[currentSelectedRoleId].bonusSettings = JSON.parse(JSON.stringify(currentBonusSettings));
                
                // Save to localStorage
                saveToLocalStorage('commissionRoles', rolesData);
                
                // Recalculate bonuses with new settings
                calculateBonuses();
            }
        }

        function handleSaveRoleSettings() {
            saveCurrentSettings();
            showStatusMessage('×”×’×“×¨×•×ª ×”×ª×¤×§×™×“ × ×©××¨×• ×‘×”×¦×œ×—×”!', true);
        }

        function handleResetForm() {
            // Reset all form inputs to default values
            repNameInput.value = '× ×¦×™×’ ×œ×“×•×’××”';
            const now = new Date();
            periodMonthInput.value = now.getMonth() + 1;
            periodYearInput.value = now.getFullYear();
            
            // Reset all category inputs
            currentCategoryDefinitions.forEach(cat => {
                if (cat.goalInput) {
                    const goalInputEl = document.getElementById(`${cat.id}Goal`);
                    if (goalInputEl) goalInputEl.value = 0;
                }
                if (cat.actualInput) {
                    const actualInputEl = document.getElementById(`${cat.id}Actual`);
                    if (actualInputEl) actualInputEl.value = 0;
                }
            });
            
            // Reset profile selection
            profilesDropdown.value = '';
            
            // Recalculate with reset values
            calculateBonuses();
            
            showStatusMessage('×”×˜×•×¤×¡ ××•×¤×¡!', true);
        }

        // --- BONUS CALCULATION FUNCTIONS ---
        function calculateBonuses() {
            if (!currentSelectedRoleId || !currentCategoryDefinitions || currentCategoryDefinitions.length === 0) {
                totalBonusAmount.textContent = formatCurrency(0);
                totalPerformanceBonus.textContent = formatCurrency(0);
                totalTargetBonus.textContent = formatCurrency(0);
                performanceBonusList.innerHTML = '<li class="text-gray-500">×× × ×‘×—×¨ ×ª×¤×§×™×“ ×•×‘×–×Ÿ × ×ª×•× ×™×</li>';
                targetBonusList.innerHTML = '<li class="text-gray-500">×× × ×‘×—×¨ ×ª×¤×§×™×“ ×•×‘×–×Ÿ × ×ª×•× ×™×</li>';
                return;
            }

            let totalPerformanceBonusAmount = 0;
            let totalTargetBonusAmount = 0;
            let performanceHTML = '';
            let targetHTML = '';

            // Update result display
            resultRepName.textContent = repNameInput.value || '× ×¦×™×’ ×œ× ××•×’×“×¨';
            resultPeriod.textContent = `${periodMonthInput.value}/${periodYearInput.value}`;

            currentCategoryDefinitions.forEach(cat => {
                const goalValue = getInputValue(`${cat.id}Goal`);
                const actualValue = getInputValue(`${cat.id}Actual`);
                const settings = currentBonusSettings[cat.id] || {};

                let performanceBonus = 0;
                let targetBonus = 0;
                let performanceText = '';
                let targetText = '';

                if (cat.type === 'performance_tiered_percentage') {
                    const percentage = goalValue > 0 ? actualValue / goalValue : 0;
                    const tiers = settings.tiers || [];
                    
                    // Find applicable tier
                    const applicableTier = tiers
                        .sort((a, b) => b.threshold - a.threshold)
                        .find(tier => percentage >= tier.threshold);
                    
                    if (applicableTier) {
                        performanceBonus = actualValue * applicableTier.value;
                        performanceText = `${cat.name}: ${formatCurrency(actualValue)} Ã— ${applicableTier.value} (${formatPercentage(percentage)}) = ${formatCurrency(performanceBonus)}`;
                    }

                    // Target bonus
                    if (settings.targetThreshold && settings.targetBonus && percentage >= settings.targetThreshold) {
                        targetBonus = settings.targetBonus;
                        targetText = `${cat.name}: ×¢××™×“×” ×‘×™×¢×“ âœ“ = ${formatCurrency(targetBonus)}`;
                    }
                } else if (cat.type === 'performance_fixed_multiplier') {
                    performanceBonus = actualValue * (settings.multiplier || 0);
                    performanceText = `${cat.name}: ${formatCurrency(actualValue)} Ã— ${settings.multiplier || 0} = ${formatCurrency(performanceBonus)}`;
                } else if (cat.type === 'threshold_only') {
                    const percentage = goalValue > 0 ? actualValue / goalValue : 0;
                    if (settings.targetThreshold && settings.targetBonus && percentage >= settings.targetThreshold) {
                        targetBonus = settings.targetBonus;
                        targetText = `${cat.name}: ×¢××™×“×” ×‘×™×¢×“ âœ“ = ${formatCurrency(targetBonus)}`;
                    }
                }

                totalPerformanceBonusAmount += performanceBonus;
                totalTargetBonusAmount += targetBonus;

                if (performanceText) performanceHTML += `<li>${performanceText}</li>`;
                if (targetText) targetHTML += `<li>${targetText}</li>`;
            });

            // Update display
            totalPerformanceBonus.textContent = formatCurrency(totalPerformanceBonusAmount);
            totalTargetBonus.textContent = formatCurrency(totalTargetBonusAmount);
            totalBonusAmount.textContent = formatCurrency(totalPerformanceBonusAmount + totalTargetBonusAmount);
            
            performanceBonusList.innerHTML = performanceHTML || '<li class="text-gray-500">××™×Ÿ ×‘×•× ×•×¡ ×‘×™×¦×•×¢×™×</li>';
            targetBonusList.innerHTML = targetHTML || '<li class="text-gray-500">××™×Ÿ ×‘×•× ×•×¡ ×™×¢×“×™×</li>';
        }

        // --- PROFILE MANAGEMENT FUNCTIONS ---
        function loadUserProfiles() {
            if (!currentSelectedRoleId) return;
            
            const roleProfiles = loadFromLocalStorage(`profiles_${currentSelectedRoleId}`, {});
            profiles = roleProfiles;
            
            profilesDropdown.innerHTML = '<option value="">×˜×¢×Ÿ ×¤×¨×•×¤×™×œ...</option>';
            Object.keys(profiles).forEach(profileName => {
                const option = document.createElement('option');
                option.value = profileName;
                option.textContent = profileName;
                profilesDropdown.appendChild(option);
            });
        }

        function handleSaveProfile() {
            if (!currentSelectedRoleId) {
                showStatusMessage('×× × ×‘×—×¨ ×ª×¤×§×™×“ ×ª×—×™×œ×”', false);
                return;
            }

            const profileName = prompt('×”×›× ×¡ ×©× ×œ×¤×¨×•×¤×™×œ:');
            if (!profileName || profileName.trim() === '') return;

            const profileData = {
                repName: repNameInput.value,
                periodMonth: periodMonthInput.value,
                periodYear: periodYearInput.value,
                categoryData: {}
            };

            currentCategoryDefinitions.forEach(cat => {
                profileData.categoryData[cat.id] = {
                    goal: getInputValue(`${cat.id}Goal`),
                    actual: getInputValue(`${cat.id}Actual`)
                };
            });

            profiles[profileName.trim()] = profileData;
            saveToLocalStorage(`profiles_${currentSelectedRoleId}`, profiles);
            loadUserProfiles();
            showStatusMessage(`×¤×¨×•×¤×™×œ "${profileName}" × ×©××¨ ×‘×”×¦×œ×—×”!`, true);
        }

        function handleLoadProfile() {
            const profileName = profilesDropdown.value;
            if (!profileName || !profiles[profileName]) return;

            const profileData = profiles[profileName];
            
            repNameInput.value = profileData.repName || '';
            periodMonthInput.value = profileData.periodMonth || '';
            periodYearInput.value = profileData.periodYear || '';

            currentCategoryDefinitions.forEach(cat => {
                const catData = profileData.categoryData[cat.id];
                if (catData) {
                    const goalInput = document.getElementById(`${cat.id}Goal`);
                    const actualInput = document.getElementById(`${cat.id}Actual`);
                    if (goalInput) goalInput.value = catData.goal || 0;
                    if (actualInput) actualInput.value = catData.actual || 0;
                }
            });

            calculateBonuses();
            showStatusMessage(`×¤×¨×•×¤×™×œ "${profileName}" × ×˜×¢×Ÿ ×‘×”×¦×œ×—×”!`, true);
        }

        function handleDeleteProfile() {
            const profileName = profilesDropdown.value;
            if (!profileName || !profiles[profileName]) {
                showStatusMessage('×× × ×‘×—×¨ ×¤×¨×•×¤×™×œ ×œ××—×™×§×”', false);
                return;
            }

            if (confirm(`×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×”×¤×¨×•×¤×™×œ "${profileName}"?`)) {
                delete profiles[profileName];
                saveToLocalStorage(`profiles_${currentSelectedRoleId}`, profiles);
                loadUserProfiles();
                showStatusMessage(`×¤×¨×•×¤×™×œ "${profileName}" × ××—×§ ×‘×”×¦×œ×—×”!`, true);
            }
        }

        // --- EXPORT FUNCTIONS ---
        function handlePrint() {
            window.print();
        }

        function handleExportCsv() {
            if (!currentSelectedRoleId) {
                showStatusMessage('×× × ×‘×—×¨ ×ª×¤×§×™×“ ×ª×—×™×œ×”', false);
                return;
            }

            const csvData = [];
            csvData.push(['×©× ×”× ×¦×™×’', '×ª×¤×§×™×“', '×ª×§×•×¤×”', '×¡×•×’ ×‘×•× ×•×¡', '×¡×›×•×']);
            
            const repName = repNameInput.value || '× ×¦×™×’ ×œ× ××•×’×“×¨';
            const roleName = rolesData[currentSelectedRoleId].name;
            const period = `${periodMonthInput.value}/${periodYearInput.value}`;
            
            // Add performance bonuses
            currentCategoryDefinitions.forEach(cat => {
                const goalValue = getInputValue(`${cat.id}Goal`);
                const actualValue = getInputValue(`${cat.id}Actual`);
                const settings = currentBonusSettings[cat.id] || {};
                
                if (cat.type === 'performance_tiered_percentage') {
                    const percentage = goalValue > 0 ? actualValue / goalValue : 0;
                    const tiers = settings.tiers || [];
                    const applicableTier = tiers
                        .sort((a, b) => b.threshold - a.threshold)
                        .find(tier => percentage >= tier.threshold);
                    
                    if (applicableTier) {
                        const bonus = actualValue * applicableTier.value;
                        csvData.push([repName, roleName, period, `×‘×•× ×•×¡ ×‘×™×¦×•×¢×™× - ${cat.name}`, bonus]);
                    }
                }
            });

            const csvContent = csvData.map(row => row.join(',')).join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `bonus_report_${repName}_${period}.csv`;
            link.click();
            
            showStatusMessage('×§×•×‘×¥ CSV ×™×•×¦× ×‘×”×¦×œ×—×”!', true);
        }

        // --- INITIALIZATION ---
        function initializeApp() {
            showStatusMessage("×˜×•×¢×Ÿ ××¤×œ×™×§×¦×™×”...", true);

            // Setup event listeners
            roleSelector.addEventListener('change', handleRoleChange);
            
            // Debug: Add detailed logging for settings toggle
            console.log("ğŸ”§ DEBUG: Setting up settings toggle");
            console.log("toggleSettingsBtn:", toggleSettingsBtn);
            console.log("settingsPanel:", settingsPanel);
            
            if (!toggleSettingsBtn) {
                console.error("âŒ toggleSettingsBtn element not found!");
                showStatusMessage("×©×’×™××”: ×›×¤×ª×•×¨ ×”×’×“×¨×•×ª ×œ× × ××¦×", false);
                return;
            }
            
            if (!settingsPanel) {
                console.error("âŒ settingsPanel element not found!");
                showStatusMessage("×©×’×™××”: ×¤×× ×œ ×”×’×“×¨×•×ª ×œ× × ××¦×", false);
                return;
            }
            
            toggleSettingsBtn.addEventListener('click', () => {
                console.log("ğŸ”„ Toggle settings button clicked!");
                
                // Check if a role is selected first
                if (!currentSelectedRoleId) {
                    showStatusMessage('×× × ×‘×—×¨ ×ª×¤×§×™×“ ×ª×—×™×œ×” ×›×“×™ ×œ×¦×¤×•×ª ×‘×”×’×“×¨×•×ª', false);
                    return;
                }
                
                console.log("Panel current display:", settingsPanel.style.display);
                console.log("Panel computed display:", window.getComputedStyle(settingsPanel).display);
                
                const isHidden = settingsPanel.style.display === 'none' || settingsPanel.style.display === '';
                console.log("Panel is hidden:", isHidden);
                
                settingsPanel.style.display = isHidden ? 'block' : 'none';
                toggleSettingsBtn.textContent = isHidden ? '×”×¡×ª×¨ ×”×’×“×¨×•×ª' : '×”×¦×’ ×”×’×“×¨×•×ª ×ª×¤×§×™×“';
                
                console.log("Panel new display:", settingsPanel.style.display);
                console.log("Button new text:", toggleSettingsBtn.textContent);
                
                // Ensure the settings form is built for the current role
                if (isHidden && currentCategoryDefinitions && currentCategoryDefinitions.length > 0) {
                    buildSettingsForm(currentCategoryDefinitions, currentBonusSettings);
                }
                
                // Force visibility check
                setTimeout(() => {
                    console.log("After timeout - Panel computed display:", window.getComputedStyle(settingsPanel).display);
                    console.log("After timeout - Panel visibility:", window.getComputedStyle(settingsPanel).visibility);
                    console.log("After timeout - Panel opacity:", window.getComputedStyle(settingsPanel).opacity);
                }, 100);
            });
            
            console.log("âœ… Settings toggle event listener attached");
            
            saveRoleSettingsBtn.addEventListener('click', handleSaveRoleSettings);
            saveProfileBtn.addEventListener('click', handleSaveProfile);
            profilesDropdown.addEventListener('change', handleLoadProfile);
            deleteProfileBtn.addEventListener('click', handleDeleteProfile);
            resetFormBtn.addEventListener('click', handleResetForm);
            printBtn.addEventListener('click', handlePrint);
            exportCsvBtn.addEventListener('click', handleExportCsv);
            
            // Add debug button functionality
            document.getElementById('debugBtn').addEventListener('click', () => {
                console.log("ğŸ”§ DEBUG INFO:");
                console.log("- currentSelectedRoleId:", currentSelectedRoleId);
                console.log("- rolesData:", rolesData);
                console.log("- roleSelector.value:", roleSelector.value);
                console.log("- toggleSettingsBtn.disabled:", toggleSettingsBtn.disabled);
                console.log("- Number of roles available:", Object.keys(rolesData).length);
                
                // Force enable the settings button for testing
                if (Object.keys(rolesData).length > 0) {
                    const firstRoleId = Object.keys(rolesData)[0];
                    roleSelector.value = firstRoleId;
                    handleRoleChange();
                    showStatusMessage(`ğŸ”§ Debug: Forced selection of role "${rolesData[firstRoleId].name}"`, true);
                }
            });
            
            // Set initial values
            repNameInput.value = '× ×¦×™×’ ×œ×“×•×’××”';
            const now = new Date();
            periodMonthInput.value = now.getMonth() + 1;
            periodYearInput.value = now.getFullYear();

            // Load data and start
            loadAllRoles();
            
            showStatusMessage("××¤×œ×™×§×¦×™×” × ×˜×¢× ×” ×‘×”×¦×œ×—×”!", true);
        }
        
        // --- PAGE LOAD ---
        document.addEventListener('DOMContentLoaded', initializeApp);
        
        // Additional fallback initialization
        window.addEventListener('load', () => {
            if (!currentSelectedRoleId) {
                initializeApp();
            }
        });
    </script>
</body>
</html>